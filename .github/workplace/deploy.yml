const { spawnSync } = require('child_process')
const { existsSync, writeFileSync } = require('fs')

const SESSION_ID = 'eyJub2lzZUtleSI6eyJwcml2YXRlIjp7InR5cGUiOiJCdWZmZXIiLCJkYXRhIjoiUURlRDUwZGR1WW5OTlU2ZmRuRFMvMWhsUnJmT2pUTTE0VnlDUnFaWmJWYz0ifSwicHVibGljIjp7InR5cGUiOiJCdWZmZXIiLCJkYXRhIjoiSWVYcWdDKzBTQVVsSEVjcFNnVCtXYXZ0STdtNTU2V2wxUk9YR05tcDJpND0ifX0sInBhaXJpbmdFcGhlbWVyYWxLZXlQYWlyIjp7InByaXZhdGUiOnsidHlwZSI6IkJ1ZmZlciIsImRhdGEiOiJrTjZ5WUlCN3N1LzBUQk91N0hOM3ZJcWZTajFnYWQ2ME9kZ2Q5SkdsT0Y0PSJ9LCJwdWJsaWMiOnsidHlwZSI6IkJ1ZmZlciIsImRhdGEiOiIzdGhGQndCQ0R1ZGZWb3h1MHdwUkRSZzdhSGh6RkNscnY4UWhid3B1eTFrPSJ9fSwic2lnbmVkSWRlbnRpdHlLZXkiOnsicHJpdmF0ZSI6eyJ0eXBlIjoiQnVmZmVyIiwiZGF0YSI6Im1QeDRHTmZBNitkU2ZxVGd2QWRPbmkrczg4YUhMNTVJdXdFOEZkaUZoVTQ9In0sInB1YmxpYyI6eyJ0eXBlIjoiQnVmZmVyIiwiZGF0YSI6IktoSWJDRXNyTFhLYk80UDNvWStCSmNaUitiREVUSWRPU0psbU1IdUNQa3c9In19LCJzaWduZWRQcmVLZXkiOnsia2V5UGFpciI6eyJwcml2YXRlIjp7InR5cGUiOiJCdWZmZXIiLCJkYXRhIjoiYUdvUFUxMUFKb1lDNHJOaVZheW5WRDM1NnZNODFlOU9kYkpYNlZkUTFGOD0ifSwicHVibGljIjp7InR5cGUiOiJCdWZmZXIiLCJkYXRhIjoicGt4YkhSYm55R3Uvb2xORVYvQ0UyWmQ1K3lFOEhMMXd1akRRY3BUTnl4cz0ifX0sInNpZ25hdHVyZSI6eyJ0eXBlIjoiQnVmZmVyIiwiZGF0YSI6ImdtalVlZVRrTkw3T2QwejZuN3BwampWWDU5S0tYSm1ydlhTV0MzNlJ3OFdrSHJmSmVoaTZ3bk5QRXNtUXdwVVZadmkzODVkQW5aanJpUEQ5NVFzcWpBPT0ifSwia2V5SWQiOjF9LCJyZWdpc3RyYXRpb25JZCI6MjcsImFkdlNlY3JldEtleSI6ImhHb2MyWmpycVYvcFppdmZaenovODBSZThSMFhBUStWOWhBM3M2cElKQU09IiwicHJvY2Vzc2VkSGlzdG9yeU1lc3NhZ2VzIjpbXSwibmV4dFByZUtleUlkIjozMSwiZmlyc3RVbnVwbG9hZGVkUHJlS2V5SWQiOjMxLCJhY2NvdW50U3luY0NvdW50ZXIiOjAsImFjY291bnRTZXR0aW5ncyI6eyJ1bmFyY2hpdmVDaGF0cyI6ZmFsc2V9LCJkZXZpY2VJZCI6IjdBLW9KVmpQUzRDaHdEa1NaZTRSblEiLCJwaG9uZUlkIjoiMmQxNTRjYjQtZjgyYS00YWNlLWI4NDItNGZiZWU3MmM4YTEzIiwiaWRlbnRpdHlJZCI6eyJ0eXBlIjoiQnVmZmVyIiwiZGF0YSI6IkQ0MngwSEVHTjVQZUZqRjFqQVhHV3BRUUpJVT0ifSwicmVnaXN0ZXJlZCI6dHJ1ZSwiYmFja3VwVG9rZW4iOnsidHlwZSI6IkJ1ZmZlciIsImRhdGEiOiJHclpGeC8wamx2ZWo4NGVPd0JmY1FZRHhQaTA9In0sInJlZ2lzdHJhdGlvbiI6e30sInBhaXJpbmdDb2RlIjoiTDI4OUZNRUgiLCJtZSI6eyJpZCI6IjIzNDgxMDk5NjYyNDc6NDNAcy53aGF0c2FwcC5uZXQiLCJuYW1lIjoiQ29sdGFyLjA3In0sImFjY291bnQiOnsiZGV0YWlscyI6IkNJSEkxNXNDRU5DdHhMZ0dHQUlnQUNnQSIsImFjY291bnRTaWduYXR1cmVLZXkiOiJnSFFOeGk5cy9aWUFERWh0R3pEWTZHRWxCdFlNZ0lYcUNadExRTWNhcWpzPSIsImFjY291bnRTaWduYXR1cmUiOiJZcWhqQWxoTUZNMjdTeHcxQVI1SXNmWHFzdmJCUVRNVFJOZnN0by9SdTREbHFYL2R3UVErdFQwNGFPWmRwVXVrSE5QeHJFbVFvWEMxQTJGajJyeVlCUT09IiwiZGV2aWNlU2lnbmF0dXJlIjoiaDhObGgxdm5ocFFTQURQdVhHd3hUL25IdkRFQStxcEJ4MGdsakhmakVieDBTZFBRLy8zVTdwT2JBMVErSCsxTDMxWFVMa0hPQ2xEdytJRGZLTG51Z3c9PSJ9LCJzaWduYWxJZGVudGl0aWVzIjpbeyJpZGVudGlmaWVyIjp7Im5hbWUiOiIyMzQ4MTA5OTY2MjQ3OjQzQHMud2hhdHNhcHAubmV0IiwiZGV2aWNlSWQiOjB9LCJpZGVudGlmaWVyS2V5Ijp7InR5cGUiOiJCdWZmZXIiLCJkYXRhIjoiQllCMERjWXZiUDJXQUF4SWJSc3cyT2hoSlFiV0RJQ0Y2Z21iUzBESEdxbzcifX1dLCJwbGF0Zm9ybSI6InNtYmEiLCJsYXN0QWNjb3VudFN5bmNUaW1lc3RhbXAiOjE3MjkxNzMyMTN9' // Edit this line only, don't remove ' <- this symbol

if (!existsSync('Itxxwasi')) {
  console.log('Cloning the repository...')
  const cloneResult = spawnSync(
    'git',
    ['clone', 'https://github.com/Itxxwasi/WASI-MD-V.git', 'Itxxwasi'],
    {
      stdio: 'inherit',
    }
  )

  if (cloneResult.error) {
    throw new Error(`Failed to clone the repository: ${cloneResult.error.message}`)
  }

  const configPath = 'Itxxwasi/config.env'
  try {
    console.log('Writing to config.env...')
    writeFileSync(configPath, `VPS=true\nSESSION_ID=${SESSION_ID}`)
  } catch (err) {
    throw new Error(`Failed to write to config.env: ${err.message}`)
  }

  console.log('Installing dependencies...')
  const installResult = spawnSync('yarn', ['install', '--network-concurrency', '3'], {
    cwd: 'Itxxwasi',
    stdio: 'inherit',
  })

  if (installResult.error) {
    throw new Error(`Failed to install dependencies: ${installResult.error.message}`)
  }
}

spawnSync('yarn', ['start'], { cwd: 'Itxxwasi', stdio: 'inherit' })
